name: Build KernelSU LKM for OPPO K10x (Tutorial Optimized)

on:
  push:
    
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          # 精简后的依赖列表，移除有冲突的旧包，确保 22.04 必中
          sudo apt-get install -y bc bison build-essential curl flex git git-lfs \
            gnupg gperf libelf-dev libncurses-dev libssl-dev libxml2-utils \
            lzop rsync schedtool squashfs-tools xsltproc zip zlib1g-dev \
            gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi

      - name: Setup Clang 12 (Stable Version)
        run: |
          echo "Cloning Clang 12..."
          git clone https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86 --depth=1 -b android-12.1.0_r27 clang-repo
          mv clang-repo/clang-r416183b clang
          rm -rf clang-repo
          echo "CLANG_PATH=$(pwd)/clang" >> $GITHUB_ENV

      - name: Build KernelSU LKM
        run: |
            # 1. 克隆源码
            git clone --depth=1 -b oppo/sm6375_u_14.0.0_k10x_5g https://github.com/oppo-source/android_kernel_oppo_sm6375.git kernel-source
            cd kernel-source

            # 2. 源码深度修复 (针对 OPPO 遗留的引用错误)
            echo "Repairing Source Tree..."
            
            # A. 转换换行符
            find . -type f \( -name "Kconfig*" -o -name "Makefile" -o -name "*.mk" \) -exec sed -i 's/\r$//' {} +
            
            # B. 核心修复：查找并删除所有不存在的 Kconfig 引用
            # 我们遍历所有的 Kconfig 文件，检查里面 source 指向的文件是否存在，如果不存在就删除整行
            find . -name "Kconfig*" | while read -r kfile; do
                # 提取所有 source "..." 里的路径
                lines=$(grep -oP 'source "\K[^"]+' "$kfile")
                for line in $lines; do
                    # 转换为相对于内核根目录的路径
                    if [[ "$line" == /* ]]; then
                        target_path=".$line"
                    elif [[ "$line" == .* ]]; then
                        target_path="$(dirname "$kfile")/$line"
                    else
                        target_path="$line"
                    fi
                    
                    # 如果目标文件不存在，直接从 Kconfig 中删掉这一行
                    if [ ! -f "$target_path" ]; then
                        echo "Removing broken reference in $kfile: $line"
                        sed -i "\|source \"$line\"|d" "$kfile"
                    fi
                done
            done

            # C. 屏蔽 techpack 和其他可能缺失的目录
            sed -i 's/obj-y += techpack\///g' Makefile 2>/dev/null || true
            # 清理失效链接
            find . -type l ! -exec test -e {} \; -delete

            # 3. 集成 KernelSU
            echo "Setting up KernelSU..."
            curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -
            
            # 4. 定义编译参数
            export PATH=${{ env.CLANG_PATH }}/bin:$PATH
            ARGS="ARCH=arm64 \
            SUBARCH=arm64 \
            CC=clang \
            LD=ld.lld \
            AR=llvm-ar \
            NM=llvm-nm \
            OBJCOPY=llvm-objcopy \
            OBJDUMP=llvm-objdump \
            STRIP=llvm-strip \
            CROSS_COMPILE=aarch64-linux-gnu- \
            CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
            CLANG_TRIPLE=aarch64-linux-gnu- \
            LLVM=1 \
            LLVM_IAS=1"

            # 5. 生成配置
            echo "Generating Defconfig..."
            cat arch/arm64/configs/gki_defconfig arch/arm64/configs/vendor/holi_GKI.config > arch/arm64/configs/k10x_defconfig
            make $ARGS k10x_defconfig
            
            echo "CONFIG_KSU_LKM=y" >> .config
            echo "CONFIG_MODULES=y" >> .config
            echo "CONFIG_MODULE_SIG=n" >> .config
            echo "CONFIG_UNUSED_SYMBOLS=y" >> .config
            
            make $ARGS olddefconfig

            # 6. 编译
            echo "Starting build..."
            make $ARGS prepare -j$(nproc)
            make $ARGS M=drivers/kernelsu -j$(nproc)

            # 7. 检查
            if [ -f "drivers/kernelsu/kernelsu.ko" ]; then
                echo "SUCCESS!"
                cp drivers/kernelsu/kernelsu.ko ../
            else
                echo "ERROR: kernelsu.ko not found!"
                exit 1
            fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: kernelsu-ko-pggm10
          path: kernelsu.ko