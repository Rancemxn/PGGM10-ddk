name: Build KernelSU LKM for OPPO K10x

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison libssl-dev libelf-dev clang lld llvm-dev crossbuild-essential-arm64

      - name: Sync OPPO Kernel Source
        run: |
          # 依然克隆你找的这个分支
          git clone --depth=1 -b oppo/sm6375_u_14.0.0_k10x_5g https://github.com/oppo-source/android_kernel_oppo_sm6375.git kernel-source

      - name: Repair Kernel Source (Robust Auto-Fix)
        run: |
          cd kernel-source
          
          # 1. 修复 Kconfig 引用
          # 扫描 init/Kconfig 和 arch/arm64/Kconfig，把 source 指向的不存在文件全部删掉
          echo "Auto-fixing Kconfig files..."
          for kfile in init/Kconfig arch/arm64/Kconfig; do
              if [ -f "$kfile" ]; then
                  # 提取 source "xxx" 中的路径并检查
                  grep -oP 'source "\K[^"]+' "$kfile" | while read -r line; do
                      if [ ! -f "$line" ]; then
                          echo "  -> Removing broken reference: $line in $kfile"
                          # 使用 | 作为 sed 分隔符，防止路径中的 / 导致报错
                          sed -i "\|source \"$line\"|d" "$kfile"
                      fi
                  done
              fi
          done

          # 2. 清理失效的软链接 (Symlinks)
          # 你截图看到的 kernel/sched_assist 就是这种，它指向 vendor 目录但代码没给
          echo "Cleaning broken symlinks..."
          find . -type l ! -exec test -e {} \; -print -delete

          # 3. 屏蔽 Makefile 里的 techpack (欧加源码的常客报错)
          # 如果 Makefile 里包含编译不存在的 techpack 目录，会导致编译中断
          sed -i 's/obj-y += techpack\///g' Makefile 2>/dev/null || true
          
          echo "Repair complete."

      - name: Setup KernelSU
        run: |
          cd kernel-source
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -
          
          # 确保开启模块支持
          # 这里要注意路径，根据你之前的截图，configs 在 arch/arm64/configs/vendor 下
          DEFCONFIG="arch/arm64/configs/defconfig"
          echo "CONFIG_KSU_LKM=y" >> $DEFCONFIG
          echo "CONFIG_MODULES=y" >> $DEFCONFIG
          echo "CONFIG_MODULE_SIG=n" >> $DEFCONFIG # 关闭签名校验，防止加载失败

      - name: Build LKM
        run: |
          cd kernel-source
          export ARCH=arm64
          export CROSS_COMPILE=aarch64-linux-gnu-
          export CC=clang
          export CLANG_TRIPLE=aarch64-linux-gnu-
          
          # 生成配置
          make vendor/sm6375_defconfig
          
          # 开始编译模块
          # 如果报错提示缺少某些头文件，尝试执行：make modules_prepare
          make modules_prepare
          make M=drivers/kernelsu -j$(nproc)

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: kernelsu-ko
          path: kernel-source/drivers/kernelsu/kernelsu.ko