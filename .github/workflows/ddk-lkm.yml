name: Build KernelSU LKM for OPPO K10x (Tutorial Optimized)

on:
  push:
    
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Dependencies
        run: |
          sudo apt-get update
          # 精简后的依赖列表，移除有冲突的旧包，确保 22.04 必中
          sudo apt-get install -y bc bison build-essential curl flex git git-lfs \
            gnupg gperf libelf-dev libncurses-dev libssl-dev libxml2-utils \
            lzop rsync schedtool squashfs-tools xsltproc zip zlib1g-dev \
            gcc-aarch64-linux-gnu gcc-arm-linux-gnueabi

      - name: Setup Clang 12 (Stable Version)
        run: |
          echo "Cloning Clang 12..."
          git clone https://android.googlesource.com/platform/prebuilts/clang/host/linux-x86 --depth=1 -b android-12.1.0_r27 clang-repo
          mv clang-repo/clang-r416183b clang
          rm -rf clang-repo
          echo "CLANG_PATH=$(pwd)/clang" >> $GITHUB_ENV

      - name: Build KernelSU LKM
        run: |
          # 1. 克隆源码
          git clone --depth=1 -b oppo/sm6375_u_14.0.0_k10x_5g https://github.com/oppo-source/android_kernel_oppo_sm6375.git kernel-source
          cd kernel-source

          # 2. 源码环境修复 (包含 Kconfig 修复和 sched_assist 修复)
          echo "Repairing Source Tree..."
          find . -type f \( -name "Kconfig*" -o -name "Makefile" -o -name "*.mk" \) -exec sed -i 's/\r$//' {} +
          sed -i '/kernel\/sched_assist\/Kconfig/d' init/Kconfig
          sed -i 's/obj-y += techpack\///g' Makefile 2>/dev/null || true
          
          # 3. 集成 KernelSU
          echo "Setting up KernelSU..."
          curl -LSs "https://raw.githubusercontent.com/tiann/KernelSU/main/kernel/setup.sh" | bash -
          
          # 4. 定义编译变量
          export PATH=${{ env.CLANG_PATH }}/bin:$PATH
          
          # 简化参数：针对 4.19/5.4/5.10 内核最稳妥的组合
          MAKE_ARGS="ARCH=arm64 \
          SUBARCH=arm64 \
          CC=clang \
          CROSS_COMPILE=aarch64-linux-gnu- \
          CROSS_COMPILE_ARM32=arm-linux-gnueabi- \
          CLANG_TRIPLE=aarch64-linux-gnu- \
          LD=ld.lld"

          # 5. 生成配置文件 (使用 merge_config.sh)
          echo "Merging Defconfigs..."
          # 使用内核自带工具合并 GKI 配置和 Holi 厂商配置
          ARCH=arm64 ./scripts/kconfig/merge_config.sh -m -O . \
            arch/arm64/configs/gki_defconfig \
            arch/arm64/configs/vendor/holi_GKI.config

          # 强制在 .config 中开启 64 位和模块支持，防止被误判为 32 位
          echo "CONFIG_64BIT=y" >> .config
          echo "CONFIG_KSU_LKM=y" >> .config
          echo "CONFIG_MODULES=y" >> .config
          echo "CONFIG_MODULE_SIG=n" >> .config
          echo "CONFIG_UNUSED_SYMBOLS=y" >> .config
          
          # 应用并检查配置
          make $MAKE_ARGS olddefconfig

          # 6. 开始编译
          echo "Starting Compilation..."
          # 必须先执行 prepare 且带上所有 ARGS
          make $MAKE_ARGS prepare -j$(nproc)
          
          # 编译 KernelSU 模块
          make $MAKE_ARGS M=drivers/kernelsu -j$(nproc)

          # 7. 检查
          if [ -f "drivers/kernelsu/kernelsu.ko" ]; then
              echo "SUCCESS!"
              cp drivers/kernelsu/kernelsu.ko ../
          else
              echo "ERROR: kernelsu.ko not found!"
              exit 1
          fi

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: kernelsu-ko-pggm10
          path: kernelsu.ko